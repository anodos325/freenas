#!/sbin/openrc-run
#
# $FreeBSD$
#

. /etc/rc.freenas

name="ix-post-samba"

depend()
{
	provide ix-post-samba
	need ix-samba
}

save_sambaSID()
{
	local sambaSID

	RO_FREENAS_CONFIG=$(ro_sqlite ${name} 2> /tmp/${name}.fail && rm /tmp/${name}.fail)
	trap 'rm -f ${RO_FREENAS_CONFIG}' EXIT

	sambaSID="$(${FREENAS_SQLITE_CMD} ${RO_FREENAS_CONFIG} "
	SELECT
		cifs_SID
	FROM
		services_cifs
	ORDER BY
		-id
	LIMIT 
		1
	")"

	if [ -z "${sambaSID}" ]
	then
		export LOGNAME=anonymous
		sambaSID="$(/usr/local/bin/net getlocalsid | \
			cut -f2 -d: | awk '{ print $1 }')"

		${FREENAS_SQLITE_CMD} ${RO_FREENAS_CONFIG} "
		UPDATE
			services_cifs
		SET
			cifs_SID = '${sambaSID}'
		"
	fi
}

start()
{
	save_sambaSID
}

